name: Build Manual

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      # 第一步：安装 Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.2"
          channel: "stable"
          cache: true
          cache-key: flutter-packages

      # 第二步：清理和安装依赖
      - name: Clean and install dependencies
        run: |
          flutter clean
          flutter pub cache clean
          flutter pub get

      - name: Verify Flutter version
        run: flutter --version

      - name: Install Fastforge
        run: dart pub global activate fastforge

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 17

      # 第三步：优化构建（Windows PowerShell 兼容版本）
      - name: Build Optimized Android APK
        run: |
          # Windows PowerShell 多行命令的正确写法
          flutter build apk --split-per-abi --release `
            --obfuscate `
            --split-debug-info=./split-debug-info `
            --tree-shake-icons `
            --shrink `
            --dart-define=FLUTTER_BUILD_OPTIMIZATION=true
          
          mkdir -p dist/android
          cp build/app/outputs/flutter-apk/*.apk dist/android/
          
          echo "=== 生成的APK文件大小 ==="
          dir build/app/outputs/flutter-apk/*.apk
          foreach ($file in (Get-ChildItem build/app/outputs/flutter-apk/*.apk)) {
            $size = [math]::Round(($file.Length / 1MB), 2)
            Write-Output "$($file.Name): $size MB"
          }

      # 或者使用单行版本（更可靠）：
      - name: Build Optimized Android APK (Single Line)
        run: flutter build apk --split-per-abi --release --obfuscate --split-debug-info=./split-debug-info --tree-shake-icons --shrink --dart-define=FLUTTER_BUILD_OPTIMIZATION=true

      # 第四步：复制文件
      - name: Copy APK Files
        run: |
          mkdir -p dist/android
          cp build/app/outputs/flutter-apk/*.apk dist/android/
          echo "APK文件已复制到 dist/android/"

      # 第五步：显示文件信息
      - name: Show APK Info
        run: |
          echo "=== APK 文件信息 ==="
          dir dist/android/
          foreach ($file in (Get-ChildItem dist/android/*.apk)) {
            $size = [math]::Round(($file.Length / 1MB), 2)
            Write-Output "$($file.Name): $size MB"
          }

      # 第六步：Windows构建
      - name: Build Windows
        run: |
          fastforge package --platform windows --targets zip

      - name: Upload Dist
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
