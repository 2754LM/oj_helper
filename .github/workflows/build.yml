name: Build Manual

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      # 第一步：安装 Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.2"
          channel: "stable"
          cache: true
          cache-key: flutter-packages

      # 第二步：清理和安装依赖
      - name: Clean and install dependencies
        run: |
          flutter clean
          flutter pub cache clean
          flutter pub get

      - name: Verify Flutter version
        run: flutter --version

      - name: Install Fastforge
        run: dart pub global activate fastforge

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 17

      # 第三步：优化构建（单行版本最可靠）
      - name: Build Optimized Android APK
        run: flutter build apk --split-per-abi --release --obfuscate --split-debug-info=./split-debug-info --tree-shake-icons --shrink --dart-define=FLUTTER_BUILD_OPTIMIZATION=true

      # 第四步：创建目录并复制文件（PowerShell兼容）
      - name: Prepare Dist Directory
        run: |
          # 确保目录存在（PowerShell方式）
          if (!(Test-Path "dist/android")) {
            New-Item -ItemType Directory -Path "dist/android" -Force
          }
          
          # 清空目标目录（可选）
          Remove-Item "dist/android/*" -Force -ErrorAction SilentlyContinue

      # 第五步：复制APK文件
      - name: Copy APK Files
        run: |
          # 复制所有APK文件到dist目录
          Copy-Item -Path "build/app/outputs/flutter-apk/*.apk" -Destination "dist/android/" -Force
          Write-Output "APK文件已复制到 dist/android/"

      # 第六步：显示文件信息
      - name: Show APK Info
        run: |
          Write-Output "=== APK 文件信息 ==="
          $apkFiles = Get-ChildItem "dist/android/*.apk"
          if ($apkFiles.Count -eq 0) {
            Write-Output "未找到APK文件！"
            Get-ChildItem "build/app/outputs/flutter-apk/" -Recurse
            exit 1
          }
          
          foreach ($file in $apkFiles) {
            $size = [math]::Round(($file.Length / 1MB), 2)
            Write-Output "$($file.Name): $size MB"
          }

      # 第七步：Windows构建
      - name: Build Windows
        run: |
          fastforge package --platform windows --targets zip

      - name: Upload Dist
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
