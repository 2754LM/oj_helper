name: Build Manual

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      # 第一步：安装 Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.2"
          channel: "stable"
          cache: true
          cache-key: flutter-packages

      # 第二步：清理和安装依赖
      - name: Clean and install dependencies
        run: |
          flutter clean
          flutter pub cache clean
          flutter pub get

      - name: Verify Flutter version
        run: flutter --version

      - name: Install Fastforge
        run: dart pub global activate fastforge

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: 17

      # 第三步：优化构建（替换原来的Build步骤）
      - name: Build Optimized Android APK
        run: |
          # 使用Flutter原生命令进行深度优化构建
          flutter build apk --split-per-abi --release \
            --obfuscate \
            --split-debug-info=./split-debug-info \
            --tree-shake-icons \
            --shrink \
            --dart-define=FLUTTER_BUILD_OPTIMIZATION=true
          
          # 复制APK文件到dist目录
          mkdir -p dist/android
          cp build/app/outputs/flutter-apk/*.apk dist/android/
          
          # 显示文件大小信息
          echo "=== 生成的APK文件大小 ==="
          ls -la build/app/outputs/flutter-apk/ | grep "\.apk"
          du -h build/app/outputs/flutter-apk/*.apk

      # 第四步：Windows构建（保持原样）
      - name: Build Windows
        run: |
          fastforge package --platform windows --targets zip

      # 第五步：APK分析（可选，用于诊断）
      - name: Analyze APK Size
        run: |
          echo "=== APK组成分析 ==="
          # 使用aapt工具分析APK内容（如果可用）
          if command -v aapt &> /dev/null; then
            for apk in dist/android/*.apk; do
              echo "分析文件: $apk"
              aapt dump badging "$apk" | grep "package:"
              echo "---"
            done
          fi
          
          echo "各架构APK大小:"
          du -h dist/android/*.apk | sort -hr

      - name: Upload Dist
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
